{% extends "base.html" %}
{% block title %}Registro - EduLink{% endblock %}
{% load widget_tweaks %}

{% block body_class %}bg-registro{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card p-4 shadow-lg border-0">
      <div class="text-center mb-4">
        <i class="fas fa-user-plus fa-3x text-warning mb-3"></i>
        <h3 class="fw-bold">Crear Cuenta en EduLink</h3>
        <p class="text-muted">Complet√° tus datos para comenzar</p>
      </div>
      
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="row">
          <!-- Columna izquierda -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Nombre</label>
              {{ form.nombre|add_class:"form-control" }}
              {{ form.nombre.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Apellido</label>
              {{ form.apellido|add_class:"form-control" }}
              {{ form.apellido.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Usuario</label>
              {{ form.username|add_class:"form-control" }}
              {{ form.username.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Email</label>
              {{ form.email|add_class:"form-control" }}
              {{ form.email.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Contrase√±a</label>
              {{ form.password1|add_class:"form-control" }}
              <div class="form-text">M√≠nimo 8 caracteres y al menos una may√∫scula.</div>
              {{ form.password1.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Repetir contrase√±a</label>
              {{ form.password2|add_class:"form-control" }}
              {{ form.password2.errors }}
            </div>
          </div>

          <!-- Columna derecha -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Fecha de Nacimiento</label>
              {{ form.fecha_nacimiento|add_class:"form-control" }}
              {{ form.fecha_nacimiento.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Tel√©fono</label>
              {{ form.telefono|add_class:"form-control" }}
              {{ form.telefono.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Bio</label>
              {{ form.bio|add_class:"form-control" }}
              {{ form.bio.errors }}
            </div>

            <!-- Campos de ubicaci√≥n -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Provincia</label>
              {{ form.provincia|add_class:"form-control" }}
              {{ form.provincia.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Departamento</label>
              {{ form.departamento|add_class:"form-control" }}
              {{ form.departamento.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Municipio</label>
              {{ form.municipio|add_class:"form-control" }}
              {{ form.municipio.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Localidad</label>
              {{ form.localidad|add_class:"form-control" }}
              {{ form.localidad.errors }}
            </div>
          </div>
        </div>

        <!-- Mapa -->
        <div class="mb-4">
          <h5 class="fw-bold">üìç Tu ubicaci√≥n</h5>
          <p class="text-muted">Haz clic en el mapa para marcar tu ubicaci√≥n exacta.</p>
          <div id="map" style="height: 350px; border-radius: 8px;"></div>
          {{ form.latitud }}
          {{ form.longitud }}
          <p id="geo-msg" class="text-success small mt-2"></p>
        </div>

        <button class="btn btn-acento w-100 btn-lg py-2">
          <i class="fas fa-user-plus me-2"></i>Registrarse
        </button>
      </form>
      
      <p class="mt-3 text-muted text-center">
        ¬øYa ten√©s cuenta? <a href="{% url 'login' %}" class="fw-semibold">Iniciar sesi√≥n</a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("JS cargado correctamente ‚úÖ");

    // --- Vista previa de imagen ---
    const imagenInput = document.getElementById('id_foto_perfil');
    const previewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeButton = document.getElementById('remove-image');

    if (imagenInput) {
      imagenInput.addEventListener('change', function () {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            imagePreview.src = e.target.result;
            previewContainer.style.display = 'block';
          }
          reader.readAsDataURL(this.files[0]);
        }
      });
    }
    if (removeButton) {
      removeButton.addEventListener('click', function () {
        imagenInput.value = '';
        imagePreview.src = '';
        previewContainer.style.display = 'none';
      });
    }

    // --- Mapa con Leaflet ---
    let map = L.map('map').setView([-28.4696, -65.7795], 13); // Catamarca default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    map.on("click", async function (e) {
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng).addTo(map);

      document.getElementById("id_latitud").value = e.latlng.lat;
      document.getElementById("id_longitud").value = e.latlng.lng;
      document.getElementById("geo-msg").textContent = "Ubicaci√≥n seleccionada correctamente.";

      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}&zoom=18&addressdetails=1`;
        const resp = await fetch(url, { headers: { "Accept-Language": "es" } });
        const data = await resp.json();
        console.log("Datos Nominatim:", data);

        if (data.address) {
          if (data.address.state) {
            document.getElementById("id_provincia").value = data.address.state;
          }
          if (data.address.state_district || data.address.municipality) {
            document.getElementById("id_departamento").value = data.address.state_district || data.address.municipality;
          }
          if (data.address.city || data.address.town || data.address.village) {
            document.getElementById("id_municipio").value = data.address.city || data.address.town || data.address.village;
          }
          if (data.address.suburb || data.address.neighbourhood) {
            document.getElementById("id_localidad").value = data.address.suburb || data.address.neighbourhood;
          }
          if (data.address.road) {
            document.getElementById("id_calle").value = data.address.road;
          }
        }
      } catch (err) {
        console.error("Error en geocodificaci√≥n inversa:", err);
      }
    });
  });
</script>
{% endblock %}