{% extends "base.html" %}
{% block title %}Registro{% endblock %}
{% load widget_tweaks %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card p-4 shadow">
      <h3 class="mb-3">Crear cuenta</h3>
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% if form.errors %}
        <div class="alert alert-danger">
          <ul>
            {% for field, errors in form.errors.items %}
            {% for error in errors %}
            <li><strong>{{ field }}:</strong> {{ error }}</li>
            {% endfor %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <div class="row">
          <!-- Columna izquierda -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Usuario</label>
              {{ form.username|add_class:"form-control" }}
              {{ form.username.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              {{ form.email|add_class:"form-control" }}
              {{ form.email.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Contraseña</label>
              {{ form.password1|add_class:"form-control" }}
              <div class="form-text">Mínimo 8 caracteres y al menos una mayúscula.</div>
              {{ form.password1.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Repetir contraseña</label>
              {{ form.password2|add_class:"form-control" }}
              {{ form.password2.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Fecha de Nacimiento</label>
              {{ form.fecha_nacimiento|add_class:"form-control" }}
              {{ form.fecha_nacimiento.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Teléfono</label>
              {{ form.telefono|add_class:"form-control" }}
              {{ form.telefono.errors }}
            </div>
          </div>

          <!-- Columna derecha -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              {{ form.bio|add_class:"form-control" }}
              {{ form.bio.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Provincia</label>
              {{ form.provincia|add_class:"form-select" }}
              {{ form.provincia.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Departamento</label>
              {{ form.departamento|add_class:"form-select" }}
              {{ form.departamento.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Municipio</label>
              {{ form.municipio|add_class:"form-select" }}
              {{ form.municipio.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Localidad</label>
              {{ form.localidad|add_class:"form-select" }}
              {{ form.localidad.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Calle</label>
              {{ form.calle|add_class:"form-control" }}
              {{ form.calle.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label">Imagen de perfil</label>
              {{ form.foto_perfil }}
              <div id="image-preview-container" style="display:none;">
                <img id="image-preview" src="" class="img-thumbnail mt-2" style="max-height:150px;" alt="Vista previa">
                <button type="button" class="btn btn-sm btn-danger mt-2" id="remove-image">Eliminar imagen</button>
              </div>
              {{ form.foto_perfil.errors }}
            </div>
          </div>
        </div>

        <!-- Mapa -->
        <div class="mb-3">
          <h5>Tu ubicación</h5>
          <p class="text-muted">Haz clic en el mapa para marcar tu ubicación exacta.</p>
          <div id="map" style="height: 350px; border-radius: 8px;"></div>
          {{ form.latitud }}
          {{ form.longitud }}
          <p id="geo-msg" class="text-success small mt-2"></p>
        </div>

        <button class="btn btn-acento w-100">Registrarse</button>
      </form>
      <p class="mt-3 text-muted">¿Ya tenés cuenta? <a href="{% url 'login' %}">Iniciar sesión</a></p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // --- Vista previa de imagen ---
  const imagenInput = document.getElementById('id_foto_perfil');
  const previewContainer = document.getElementById('image-preview-container');
  const imagePreview = document.getElementById('image-preview');
  const removeButton = document.getElementById('remove-image');

  if (imagenInput) {
    imagenInput.addEventListener('change', function () {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imagePreview.src = e.target.result;
          previewContainer.style.display = 'block';
        }
        reader.readAsDataURL(this.files[0]);
      }
    });
  }
  if (removeButton) {
    removeButton.addEventListener('click', function () {
      imagenInput.value = '';
      imagePreview.src = '';
      previewContainer.style.display = 'none';
    });
  }

  // --- Mapa con Leaflet ---
  let map = L.map('map').setView([-28.4696, -65.7795], 13); // Catamarca default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let marker;
  map.on('click', function (e) {
    if (marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map);
    document.getElementById("id_latitud").value = e.latlng.lat;
    document.getElementById("id_longitud").value = e.latlng.lng;
    document.getElementById("geo-msg").textContent = "Ubicación seleccionada correctamente.";
  });

  // --- Selects dependientes ---
  const provinciaSelect = document.getElementById('id_provincia');
  const departamentoSelect = document.getElementById('id_departamento');
  const municipioSelect = document.getElementById('id_municipio');
  const localidadSelect = document.getElementById('id_localidad');

  async function cargar(url, select, childReset) {
    try {
      const resp = await fetch(url);
      const data = await resp.json();
      select.innerHTML = '<option value="">--Seleccione--</option>';
      data.forEach(obj => {
        const option = document.createElement('option');
        option.value = obj.id;
        option.textContent = obj.nombre;
        select.appendChild(option);
      });
      select.disabled = false;
      if (childReset) childReset();
    } catch (err) {
      console.error("Error cargando datos:", err);
      Swal.fire("Error", "No se pudieron cargar los datos", "error");
    }
  }

  function resetSelect(select) {
    select.innerHTML = '<option value="">--Seleccione--</option>';
    select.disabled = true;
  }

  provinciaSelect.addEventListener('change', function () {
    if (this.value) {
      cargar(`{% url 'departamentos' %}?provincia_id=${this.value}`, departamentoSelect, () => {
        resetSelect(municipioSelect);
        resetSelect(localidadSelect);
      });
    } else {
      resetSelect(departamentoSelect); resetSelect(municipioSelect); resetSelect(localidadSelect);
    }
  });

  departamentoSelect.addEventListener('change', function () {
    if (this.value) {
      cargar(`{% url 'municipios' %}?departamento_id=${this.value}`, municipioSelect, () => {
        resetSelect(localidadSelect);
      });
    } else {
      resetSelect(municipioSelect); resetSelect(localidadSelect);
    }
  });

  municipioSelect.addEventListener('change', function () {
    if (this.value) {
      cargar(`{% url 'localidades' %}?municipio_id=${this.value}`, localidadSelect);
    } else {
      resetSelect(localidadSelect);
    }
  });

  // --- Forzar precarga si ya hay provincia seleccionada ---
  document.addEventListener("DOMContentLoaded", function () {
    if (provinciaSelect.value) {
      provinciaSelect.dispatchEvent(new Event('change'));
    }
  });
</script>
{% endblock %}