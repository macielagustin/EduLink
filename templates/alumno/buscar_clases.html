{% extends "base.html" %}
{% block title %}Buscar maestros | EduLink{% endblock %}

{% block content %}
<div class="hero-wrap p-4 mb-4">
  <h3 class="fw-bold">游댌 Buscar maestros</h3>
  <p class="text-muted">Filtr치 por materia, modalidad y provincia.</p>
</div>

<div class="search-card p-3 mb-4">
  <form method="get" class="row g-3">
    <!-- Materia -->
    <div class="col-md-4">
      <label class="form-label">Materia</label>
      <select name="materia" class="form-select">
        <option value="">Todas</option>
        {% for m in materias %}
        <option value="{{ m.id }}" {% if q.materia == m.id %}selected{% endif %}>{{ m.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Modalidad -->
    <div class="col-md-4">
      <label class="form-label">Modalidad</label>
      <select name="modalidad" class="form-select">
        <option value="">Cualquiera</option>
        <option value="Online" {% if q.modalidad == "Online" %}selected{% endif %}>Online</option>
        <option value="Presencial" {% if q.modalidad == "Presencial" %}selected{% endif %}>Presencial</option>
        <option value="Ambos" {% if q.modalidad == "Ambos" %}selected{% endif %}>Ambos</option>
      </select>
    </div>

    <!-- Provincia -->
    <div class="col-md-4">
      <label class="form-label">Provincia</label>
      <select name="provincia" class="form-select">
        <option value="">Todas</option>
        {% for p in provincias %}
        <option value="{{ p.id }}" {% if q.provincia == p.id %}selected{% endif %}>{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Radio -->
    <div class="col-md-4">
      <label class="form-label">Radio (km)</label>
      <select name="radio" class="form-select">
        <option value="">Cualquiera</option>
        <option value="5" {% if q.radio == "5" %}selected{% endif %}>5 km</option>
        <option value="10" {% if q.radio == "10" %}selected{% endif %}>10 km</option>
        <option value="20" {% if q.radio == "20" %}selected{% endif %}>20 km</option>
        <option value="50" {% if q.radio == "50" %}selected{% endif %}>50 km</option>
      </select>
    </div>

    <div class="col-12 d-flex gap-2">
      <button type="submit" class="btn btn-acento">Buscar</button>
      <a href="?{% if q.materia %}materia={{ q.materia }}&{% endif %}{% if q.modalidad %}modalidad={{ q.modalidad }}&{% endif %}{% if q.provincia %}provincia={{ q.provincia }}&{% endif %}{% if q.radio %}radio={{ q.radio }}&{% endif %}view=map" 
        class="btn btn-outline-primary">
        Ver mapa
      </a>
    </div>
  </form>
</div>

{% if vista == "map" %}
<!-- Vista mapa -->
<div id="map" style="height:500px;" class="mb-4"></div>
<a href="?" class="btn btn-secondary mb-4">拘勇 Volver a lista</a>
{% else %}
<!-- Vista lista -->
{% if q.materia or q.modalidad or q.provincia %}
<div class="mb-3">
  {% if q.materia %}<span class="badge-chip">Materia seleccionada</span>{% endif %}
  {% if q.modalidad %}<span class="badge-chip">Modalidad: {{ q.modalidad }}</span>{% endif %}
  {% if q.provincia %}<span class="badge-chip">Provincia seleccionada</span>{% endif %}
</div>
{% endif %}

<div class="row g-3">
  {% if resultados %}
  {% for m, distancia in resultados %}
  <div class="col-md-4">
    <div class="feature-card">
      <h6 class="fw-bold mb-1">{{ m.usuario.first_name }} {{ m.usuario.last_name }}</h6>
      <p class="text-muted mb-1">Materias: {{ m.materias.all|join:", " }}</p>
      <p class="text-muted mb-1">Modalidad: {{ m.get_modalidad_display }}</p>
      <p class="fw-bold">游 {{ m.precio_hora }} /hora</p>

      {% if distancia %}
      <p class="text-muted">游늸 A {{ distancia }} km de tu ubicaci칩n</p>
      {% endif %}

      <a href="{% url 'detalle_maestro' m.id %}" class="btn btn-primary btn-sm">Ver perfil</a>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="col-12">
    <div class="feature-card">
      <p class="mb-0 text-muted">No se encontraron maestros con esos filtros.</p>
    </div>
  </div>
  {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if vista == "map" %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Mapa centrado en la ubicaci칩n del alumno
  var alumnoLat = {{ request.user.latitud|default_if_none:"null"|safe }};
  var alumnoLon = {{ request.user.longitud|default_if_none:"null"|safe }};

  var map = L.map('map').setView([alumnoLat, alumnoLon], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  if (alumnoLat && alumnoLon) {
    L.marker([alumnoLat, alumnoLon]).addTo(map)
      .bindPopup("游늸 Tu ubicaci칩n").openPopup();
  }

  // Marcadores de maestros
  {% for m, distancia in resultados %}
    {% if m.usuario.latitud and m.usuario.longitud %}
      L.marker([{{ m.usuario.latitud|safe }}, {{ m.usuario.longitud|safe }}]).addTo(map)
        .bindPopup("<b>{{ m.usuario.first_name }} {{ m.usuario.last_name }}</b><br>Materias: {{ m.materias.all|join:', ' }}{% if distancia %}<br>Distancia: {{ distancia }} km{% endif %}");
    {% endif %}
  {% endfor %}
</script>
{% endif %}
{% endblock %}