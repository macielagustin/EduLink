{% extends "base.html" %}
{% load static %}

{% block title %}Gestor de Tareas - EduLink{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h4 class="fw-bold mb-0">‚úÖ Gestor de Tareas</h4>
                    <p class="text-muted mb-0">Organiza tus tareas y proyectos</p>
                </div>
                <div class="card-body">
                    <!-- Formulario para nueva tarea -->
                    <!-- En la secci√≥n del formulario, verifica que los campos tengan estos IDs -->
<div class="mb-4">
    <h6 class="fw-bold mb-3">‚ûï Nueva Tarea</h6>
    <form method="post" id="tarea-form">
        {% csrf_token %}
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">T√≠tulo *</label>
                <input type="text" class="form-control" id="id_titulo" name="titulo" 
                       placeholder="T√≠tulo de la tarea..." required>
                {% if form.titulo.errors %}
                    <div class="text-danger small">{{ form.titulo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3">
                <label class="form-label">Prioridad *</label>
                <select class="form-select" id="id_prioridad" name="prioridad" required>
                    <option value="">Seleccionar...</option>
                    <option value="baja">üîµ Baja</option>
                    <option value="media" selected>üü° Media</option>
                    <option value="alta">üî¥ Alta</option>
                </select>
                {% if form.prioridad.errors %}
                    <div class="text-danger small">{{ form.prioridad.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3">
                <label class="form-label">Fecha Vencimiento</label>
                <input type="datetime-local" class="form-control" id="id_fecha_vencimiento" name="fecha_vencimiento">
                {% if form.fecha_vencimiento.errors %}
                    <div class="text-danger small">{{ form.fecha_vencimiento.errors }}</div>
                {% endif %}
            </div>
            <div class="col-12">
                <label class="form-label">Descripci√≥n</label>
                <textarea class="form-control" id="id_descripcion" name="descripcion" 
                          rows="3" placeholder="Descripci√≥n de la tarea..."></textarea>
                {% if form.descripcion.errors %}
                    <div class="text-danger small">{{ form.descripcion.errors }}</div>
                {% endif %}
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <i class="fas fa-plus me-1"></i>Agregar Tarea
                </button>
            </div>
        </div>
    </form>
</div>

                    <!-- Estad√≠sticas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">{{ total_tareas }}</h4>
                                    <small>Total Tareas</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">{{ tareas_pendientes }}</h4>
                                    <small>Pendientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">{{ tareas_completadas }}</h4>
                                    <small>Completadas</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 class="mb-0" id="proximas-vencer">0</h4>
                                    <small>Pr√≥ximas a vencer</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de tareas -->
                    <div class="tareas-container">
                        <h6 class="fw-bold mb-3">üìã Tus Tareas</h6>
                        
                        {% if tareas %}
                        <div class="list-group" id="lista-tareas">
                            {% for tarea in tareas %}
                            <div class="list-group-item d-flex justify-content-between align-items-center" data-tarea-id="{{ tarea.id }}">
                                <div class="flex-grow-1">
                                    <div class="form-check">
                                        <input class="form-check-input tarea-checkbox" type="checkbox" 
                                               data-tarea-id="{{ tarea.id }}"
                                               {% if tarea.completada %}checked{% endif %}>
                                        <label class="form-check-label {% if tarea.completada %}text-decoration-line-through text-muted{% endif %}">
                                            <strong>{{ tarea.titulo }}</strong>
                                            {% if tarea.descripcion %}
                                            <br><small class="text-muted">{{ tarea.descripcion }}</small>
                                            {% endif %}
                                            {% if tarea.fecha_vencimiento %}
                                            <br><small class="{% if tarea.esta_proxima %}text-warning{% else %}text-muted{% endif %}">
                                                <i class="fas fa-calendar me-1"></i>
                                                Vence: {{ tarea.fecha_vencimiento|date:"d/m/Y H:i" }}
                                            </small>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-{% if tarea.prioridad == 'alta' %}danger{% elif tarea.prioridad == 'media' %}warning{% else %}info{% endif %}">
                                        {{ tarea.get_prioridad_display }}
                                    </span>
                                    <button class="btn btn-sm btn-outline-danger eliminar-tarea" data-tarea-id="{{ tarea.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No tienes tareas registradas.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tareaForm = document.getElementById('tarea-form');
    const submitBtn = document.getElementById('submit-btn');
    
    // Funci√≥n para mostrar notificaci√≥n
    function mostrarNotificacion(mensaje, tipo = 'success') {
        // Eliminar notificaciones existentes
        document.querySelectorAll('.alert-dismissible').forEach(alert => alert.remove());
        
        // Crear elemento de notificaci√≥n
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        alerta.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insertar despu√©s del formulario
        document.querySelector('.mb-4').after(alerta);
        
        // Auto-eliminar despu√©s de 5 segundos
        setTimeout(() => {
            if (alerta.parentElement) {
                alerta.remove();
            }
        }, 5000);
    }
    
    // Enviar formulario de tarea - VERSI√ìN DEBUG
    tareaForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('üìù Enviando formulario...');
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
        
        // Crear FormData y agregar campos manualmente para debug
        const formData = new FormData();
        formData.append('titulo', document.getElementById('id_titulo').value);
        formData.append('descripcion', document.getElementById('id_descripcion').value);
        formData.append('prioridad', document.getElementById('id_prioridad').value);
        
        const fechaVencimiento = document.getElementById('id_fecha_vencimiento').value;
        if (fechaVencimiento) {
            formData.append('fecha_vencimiento', fechaVencimiento);
        }
        
        // Agregar CSRF token
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        console.log('üì§ Datos enviados:', {
            titulo: document.getElementById('id_titulo').value,
            prioridad: document.getElementById('id_prioridad').value,
            fecha_vencimiento: fechaVencimiento
        });
        
        fetch('{% url "gestor_tareas" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('üì• Respuesta recibida:', response.status);
            if (!response.ok) {
                return response.json().then(err => { 
                    throw err; 
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Datos de respuesta:', data);
            if (data.status === 'success') {
                mostrarNotificacion('‚úÖ Tarea creada correctamente');
                tareaForm.reset();
                
                // Recargar despu√©s de 1 segundo
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                throw new Error(data.message || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('‚ùå Error completo:', error);
            let mensajeError = 'Error al guardar la tarea';
            
            if (error.errors) {
                // Mostrar errores de validaci√≥n espec√≠ficos
                const errores = [];
                for (let campo in error.errors) {
                    errores.push(`${campo}: ${error.errors[campo].join(', ')}`);
                }
                mensajeError = 'Errores en el formulario: ' + errores.join('; ');
            } else if (error.message) {
                mensajeError = error.message;
            }
            
            mostrarNotificacion('‚ùå ' + mensajeError, 'error');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Agregar Tarea';
        });
    });
    
    // Marcar tarea como completada - VERSI√ìN MEJORADA
    document.querySelectorAll('.tarea-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const tareaId = this.dataset.tareaId;
            const completada = this.checked;
            const tareaElement = this.closest('.list-group-item');
            
            fetch(`/herramientas/tareas/${tareaId}/cambiar-estado/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `completada=${completada}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Actualizar interfaz inmediatamente
                    const label = tareaElement.querySelector('.form-check-label');
                    if (completada) {
                        label.classList.add('text-decoration-line-through', 'text-muted');
                        mostrarNotificacion('‚úÖ Tarea marcada como completada');
                    } else {
                        label.classList.remove('text-decoration-line-through', 'text-muted');
                        mostrarNotificacion('üìù Tarea marcada como pendiente');
                    }
                    
                    // Actualizar estad√≠sticas
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revertir el checkbox
                this.checked = !completada;
                mostrarNotificacion('‚ùå Error al actualizar la tarea', 'error');
            });
        });
    });
    
    // Eliminar tarea - VERSI√ìN MEJORADA
    document.querySelectorAll('.eliminar-tarea').forEach(button => {
        button.addEventListener('click', function() {
            const tareaId = this.dataset.tareaId;
            const tareaElement = this.closest('.list-group-item');
            const tituloTarea = tareaElement.querySelector('strong').textContent;
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar la tarea "${tituloTarea}"?`)) {
                fetch(`/herramientas/tareas/${tareaId}/eliminar/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Animaci√≥n de eliminaci√≥n
                        tareaElement.style.opacity = '0';
                        tareaElement.style.transition = 'opacity 0.3s';
                        
                        setTimeout(() => {
                            tareaElement.remove();
                            mostrarNotificacion('üóëÔ∏è Tarea eliminada correctamente');
                            
                            // Actualizar estad√≠sticas
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacion('‚ùå Error al eliminar la tarea', 'error');
                });
            }
        });
    });
    
    // Calcular tareas pr√≥ximas a vencer
    function calcularProximasVencer() {
        const hoy = new Date();
        const tareas = document.querySelectorAll('.list-group-item');
        let proximas = 0;
        
        tareas.forEach(tarea => {
            const fechaElement = tarea.querySelector('.text-warning');
            if (fechaElement) {
                proximas++;
            }
        });
        
        document.getElementById('proximas-vencer').textContent = proximas;
    }
    
    calcularProximasVencer();
    
    // Auto-guardar en localStorage mientras se escribe
    const camposTarea = tareaForm.querySelectorAll('input, textarea, select');
    camposTarea.forEach(campo => {
        campo.addEventListener('input', function() {
            const datosForm = {};
            camposTarea.forEach(c => {
                datosForm[c.name] = c.value;
            });
            localStorage.setItem('tareaPendiente', JSON.stringify(datosForm));
        });
    });
    
    // Cargar datos guardados al cargar la p√°gina
    const datosGuardados = localStorage.getItem('tareaPendiente');
    if (datosGuardados) {
        const datos = JSON.parse(datosGuardados);
        camposTarea.forEach(campo => {
            if (datos[campo.name] !== undefined) {
                campo.value = datos[campo.name];
            }
        });
    }
    
    // Limpiar localStorage al enviar el formulario
    tareaForm.addEventListener('submit', function() {
        localStorage.removeItem('tareaPendiente');
    });
});
</script>
{% endblock %}