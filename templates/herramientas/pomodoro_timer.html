{% extends "base.html" %}
{% load static %}

{% block title %}Pomodoro Timer - EduLink{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h4 class="fw-bold mb-0">‚è∞ Pomodoro Timer</h4>
                    <p class="text-muted mb-0">T√©cnica de estudio 25/5 - Personalizable</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Columna del Timer -->
                        <div class="col-md-6 text-center">
                            <!-- Timer -->
                            <div class="timer-container mb-4">
                                <div class="timer-circle mx-auto mb-3 position-relative">
                                    <div class="timer-display display-1 fw-bold text-primary" id="timer">
                                        25:00
                                    </div>
                                    <div class="progress position-absolute w-100" style="height: 8px; bottom: -15px;">
                                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="timer-mode h5 text-muted" id="timer-mode">
                                    Tiempo de Estudio
                                </div>
                            </div>

                            <!-- Controles -->
                            <div class="timer-controls mb-4">
                                <button class="btn btn-success btn-lg me-2" id="start-btn">
                                    <i class="fas fa-play me-1"></i>Iniciar
                                </button>
                                <button class="btn btn-warning btn-lg me-2" id="pause-btn" disabled>
                                    <i class="fas fa-pause me-1"></i>Pausar
                                </button>
                                <button class="btn btn-danger btn-lg" id="reset-btn">
                                    <i class="fas fa-stop me-1"></i>Reiniciar
                                </button>
                            </div>

                            <!-- Configuraci√≥n de tiempos -->
                            <div class="timer-settings row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Estudio (minutos)</label>
                                    <input type="number" class="form-control" id="study-time" value="25" min="1" max="60">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Descanso (minutos)</label>
                                    <input type="number" class="form-control" id="break-time" value="5" min="1" max="30">
                                </div>
                            </div>
                        </div>

                        <!-- Columna de Configuraci√≥n de Sonidos -->
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">üéµ Configuraci√≥n de Sonidos</h6>
                            
                            <!-- Sonidos de Alarma -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">üîî Sonido de Alarma:</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="alarm-sound" id="alarm1" value="campana" checked>
                                    <label class="btn btn-outline-primary" for="alarm1">Campana</label>
                                    
                                    <input type="radio" class="btn-check" name="alarm-sound" id="alarm2" value="digital">
                                    <label class="btn btn-outline-primary" for="alarm2">Digital</label>
                                    
                                    <input type="radio" class="btn-check" name="alarm-sound" id="alarm3" value="gong">
                                    <label class="btn btn-outline-primary" for="alarm3">Gong</label>
                                </div>
                            </div>

                            <!-- M√∫sica de Fondo -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-semibold">üéµ M√∫sica de Fondo:</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="background-music-toggle">
                                        <label class="form-check-label small" for="background-music-toggle">Activar</label>
                                    </div>
                                </div>
                                
                                <select class="form-select" id="background-music" disabled>
                                    <option value="lluvia">üåßÔ∏è Lluvia Relajante</option>
                                    <option value="piano">üéπ Piano Ambiental</option>
                                    <option value="naturaleza">üåø Sonidos de Naturaleza</option>
                                </select>
                                
                                <div class="mt-2">
                                    <label class="form-label small">Volumen:</label>
                                    <input type="range" class="form-range" id="music-volume" min="0" max="100" value="50" disabled>
                                </div>
                            </div>

                            <!-- Configuraci√≥n Autom√°tica -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-start" checked>
                                    <label class="form-check-label fw-semibold" for="auto-start">
                                        Iniciar autom√°ticamente siguiente periodo
                                    </label>
                                </div>
                                <small class="text-muted">El timer pasa autom√°ticamente entre estudio y descanso</small>
                            </div>

                            <!-- Estad√≠sticas -->
                            <div class="timer-stats border-top pt-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border-end py-2">
                                            <h5 class="text-primary mb-1" id="completed-sessions">0</h5>
                                            <small class="text-muted">Sesiones</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border-end py-2">
                                            <h5 class="text-success mb-1" id="total-minutes">0</h5>
                                            <small class="text-muted">Minutos</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="py-2">
                                            <h5 class="text-info mb-1" id="cycles-completed">0</h5>
                                            <small class="text-muted">Ciclos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audio Elements (hidden) -->
<audio id="alarm-campana" preload="auto">
    <source src="{% static 'audio/campana.mp3' %}" type="audio/mpeg">
</audio>
<audio id="alarm-digital" preload="auto">
    <source src="{% static 'audio/digital.mp3' %}" type="audio/mpeg">
</audio>
<audio id="alarm-gong" preload="auto">
    <source src="{% static 'audio/gong.mp3' %}" type="audio/mpeg">
</audio>
<audio id="music-lluvia" preload="auto" loop>
    <source src="{% static 'audio/lluvia.mp3' %}" type="audio/mpeg">
</audio>
<audio id="music-piano" preload="auto" loop>
    <source src="{% static 'audio/piano.mp3' %}" type="audio/mpeg">
</audio>
<audio id="music-naturaleza" preload="auto" loop>
    <source src="{% static 'audio/naturaleza.mp3' %}" type="audio/mpeg">
</audio>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const timerDisplay = document.getElementById('timer');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const timerMode = document.getElementById('timer-mode');
    const progressBar = document.getElementById('progress-bar');
    const studyTimeInput = document.getElementById('study-time');
    const breakTimeInput = document.getElementById('break-time');
    const completedSessionsElement = document.getElementById('completed-sessions');
    const totalMinutesElement = document.getElementById('total-minutes');
    const cyclesCompletedElement = document.getElementById('cycles-completed');
    
    // Elementos de audio
    const alarmSounds = {
        campana: document.getElementById('alarm-campana'),
        digital: document.getElementById('alarm-digital'),
        gong: document.getElementById('alarm-gong')
    };
    
    const backgroundMusic = {
        lluvia: document.getElementById('music-lluvia'),
        piano: document.getElementById('music-piano'),
        naturaleza: document.getElementById('music-naturaleza')
    };
    
    // Configuraci√≥n
    const musicToggle = document.getElementById('background-music-toggle');
    const musicSelect = document.getElementById('background-music');
    const musicVolume = document.getElementById('music-volume');
    const autoStart = document.getElementById('auto-start');
    
    // Variables del timer
    let timer;
    let minutes = 25;
    let seconds = 0;
    let isRunning = false;
    let isStudyTime = true;
    let totalTime = 25 * 60; // en segundos
    let currentTime = totalTime;
    
    // Estad√≠sticas
    let completedSessions = 0;
    let totalMinutesStudied = 0;
    let cyclesCompleted = 0;
    
    // Cargar estado guardado
    cargarEstado();
     
    // Inicializar
    updateDisplay();
    

    // Al inicio del script, despu√©s de las variables
// Cargar estado desde localStorage
function cargarEstado() {
    const estadoGuardado = localStorage.getItem('pomodoroEstado');
    if (estadoGuardado) {
        const estado = JSON.parse(estadoGuardado);
        completedSessions = estado.completedSessions || 0;
        totalMinutesStudied = estado.totalMinutesStudied || 0;
        cyclesCompleted = estado.cyclesCompleted || 0;
        
        completedSessionsElement.textContent = completedSessions;
        totalMinutesElement.textContent = totalMinutesStudied;
        cyclesCompletedElement.textContent = cyclesCompleted;
    }
}

    // Guardar estado en localStorage
    function guardarEstado() {
        const estado = {
            completedSessions: completedSessions,
            totalMinutesStudied: totalMinutesStudied,
            cyclesCompleted: cyclesCompleted
        };
        localStorage.setItem('pomodoroEstado', JSON.stringify(estado));
    }


    // Funciones de audio
    // Modificar la funci√≥n playAlarm para repetir en descanso
    function playAlarm() {
        const selectedAlarm = document.querySelector('input[name="alarm-sound"]:checked').value;
        if (alarmSounds[selectedAlarm]) {
            alarmSounds[selectedAlarm].currentTime = 0;
        
            // Si es tiempo de descanso, repetir el audio
            if (!isStudyTime) {
                alarmSounds[selectedAlarm].loop = true;
            } else {
                alarmSounds[selectedAlarm].loop = false;
            }
        
            alarmSounds[selectedAlarm].play().catch(e => console.log("Error reproduciendo alarma: ", e));
        }
    }
    
    function manageBackgroundMusic() {
        if (musicToggle.checked) {
            const selectedMusic = musicSelect.value;
            Object.values(backgroundMusic).forEach(music => {
                music.pause();
                music.currentTime = 0;
            });
            if (backgroundMusic[selectedMusic]) {
                backgroundMusic[selectedMusic].volume = musicVolume.value / 100;
                backgroundMusic[selectedMusic].play().catch(e => console.log("Error reproduciendo m√∫sica: ", e));
            }
        } else {
            Object.values(backgroundMusic).forEach(music => {
                music.pause();
                music.currentTime = 0;
            });
        }
    }
    
    function updateDisplay() {
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Actualizar barra de progreso
        const progressPercentage = (currentTime / totalTime) * 100;
        progressBar.style.width = `${progressPercentage}%`;
        
        // Cambiar color seg√∫n el modo
        if (isStudyTime) {
            progressBar.className = 'progress-bar bg-primary';
            timerMode.className = 'h5 text-primary';
        } else {
            progressBar.className = 'progress-bar bg-success';
            timerMode.className = 'h5 text-success';
        }
    }
    
    function startTimer() {
        if (!isRunning) {
            isRunning = true;
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            
            timer = setInterval(() => {
                if (currentTime <= 0) {
                    // Timer completado
                    clearInterval(timer);
                    isRunning = false;
                    playAlarm();
                    
                    if (isStudyTime) {
                        completedSessions++;
                        totalMinutesStudied += parseInt(studyTimeInput.value);
                        completedSessionsElement.textContent = completedSessions;
                        totalMinutesElement.textContent = totalMinutesStudied;
                    }
                    
                    if (autoStart.checked) {
                        switchMode();
                    } else {
                        startBtn.disabled = false;
                        pauseBtn.disabled = true;
                    }
                    return;
                }
                
                currentTime--;
                minutes = Math.floor(currentTime / 60);
                seconds = currentTime % 60;
                updateDisplay();
            }, 1000);
        }
    }
    
    function pauseTimer() {
        if (isRunning) {
            clearInterval(timer);
            isRunning = false;
            startBtn.disabled = false;
            pauseBtn.disabled = true;
        }
    }
    
    function resetTimer() {
        clearInterval(timer);
        isRunning = false;
        isStudyTime = true;
        setTimerTime(parseInt(studyTimeInput.value));
        timerMode.textContent = 'Tiempo de Estudio';
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        updateDisplay();
    }
    
    function setTimerTime(minutesValue) {
        minutes = minutesValue;
        seconds = 0;
        totalTime = minutesValue * 60;
        currentTime = totalTime;
        updateDisplay();
    }
    
    // En switchMode, detener la repetici√≥n cuando cambie el modo
function switchMode() {
    // Detener cualquier audio en loop
    Object.values(alarmSounds).forEach(alarm => {
        alarm.loop = false;
        alarm.pause();
    });
    
    isStudyTime = !isStudyTime;
    if (isStudyTime) {
        minutes = parseInt(document.getElementById('study-time').value);
        timerMode.textContent = 'Tiempo de Estudio';
        timerMode.className = 'h5 text-primary';
        cyclesCompleted++;
        cyclesCompletedElement.textContent = cyclesCompleted;
    } else {
        minutes = parseInt(document.getElementById('break-time').value);
        timerMode.textContent = 'Tiempo de Descanso';
        timerMode.className = 'h5 text-success';
    }
    seconds = 0;
    currentTime = minutes * 60;
    totalTime = currentTime;
    updateDisplay();
    guardarEstado();
    
    if (autoStart.checked) {
        startTimer();
    }
}
    
    // Event Listeners
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);
    
    studyTimeInput.addEventListener('change', function() {
        if (!isRunning && isStudyTime) {
            setTimerTime(parseInt(this.value));
        }
    });
    
    breakTimeInput.addEventListener('change', function() {
        if (!isRunning && !isStudyTime) {
            setTimerTime(parseInt(this.value));
        }
    });
    
    musicToggle.addEventListener('change', function() {
        musicSelect.disabled = !this.checked;
        musicVolume.disabled = !this.checked;
        manageBackgroundMusic();
    });
    
    musicSelect.addEventListener('change', manageBackgroundMusic);
    musicVolume.addEventListener('input', function() {
        Object.values(backgroundMusic).forEach(music => {
            music.volume = this.value / 100;
        });
    });
    
    // Inicializar m√∫sica de fondo si est√° activada
    if (musicToggle.checked) {
        manageBackgroundMusic();
    }
});
</script>

<style>
.timer-circle {
    max-width: 300px;
    padding: 20px;
    border: 3px solid #e9ecef;
    border-radius: 50%;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    position: relative;
}

.progress-bar {
    transition: width 1s linear;
}

.btn-group .btn {
    font-size: 0.8rem;
    padding: 0.5rem;
}
</style>
{% endblock %}